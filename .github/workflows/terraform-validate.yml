name: Terraform Validate

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  validate:
    name: Validate (${{ matrix.stack }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        stack:
          - global-policies
          - envs/bootstrap
          - envs/hub-tngs
          - envs/spoke
          - envs/peering/hub-spokes
          - envs/peering/spoke-hub

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Terraform fmt check
        run: terraform -chdir=${{ matrix.stack }} fmt -check -recursive

      - name: Terraform init (no backend)
        run: terraform -chdir=${{ matrix.stack }} init -backend=false -input=false

      - name: Terraform validate
        run: terraform -chdir=${{ matrix.stack }} validate
